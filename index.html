<!DOCTYPE html>
<html>
<head>
    <title>Riga Density Map</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <style>
        body { margin: 0; padding: 0; font-family: Arial, sans-serif; overflow: hidden; }
        #map { height: 100vh; width: 100%; z-index: 1; }
        
        /* LOADER */
        #loader {
            display: none; position: absolute; top: 50%; left: 50%;
            transform: translate(-50%, -50%); z-index: 2000;
            background: rgba(0, 0, 0, 0.7); color: white; padding: 15px 25px;
            border-radius: 5px; font-weight: bold; pointer-events: none;
        }

        /* LAYER SWITCHER (Top Center) */
        #layer-control {
            position: absolute; top: 20px; left: 50%; transform: translateX(-50%);
            z-index: 1000; background: white; border-radius: 50px; padding: 4px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2); display: flex; gap: 5px;
        }
        .layer-btn {
            border: none; background: transparent; padding: 8px 16px; border-radius: 40px;
            cursor: pointer; font-size: 13px; font-weight: bold; color: #555; transition: all 0.2s;
        }
        .layer-btn:hover { background: #f0f0f0; }
        .layer-btn.active { background: #2c3e50; color: white; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }

        /* INFO PANEL */
        #info-panel { 
            position: absolute; z-index: 1000; padding: 12px; 
            background: rgba(255,255,255,0.96); box-shadow: 0 0 15px rgba(0,0,0,0.2); 
            border-radius: 8px; font-size: 13px; max-height: 80vh; overflow-y: auto;
            display: none; 
        }
        @media (min-width: 601px) {
            #info-panel { top: 70px; right: 10px; width: 280px; display: block; }
        }
        @media (max-width: 600px) {
            #info-panel { left: 10px; right: 10px; bottom: 20px; width: auto; max-height: 40vh; }
        }

        #info-panel h4 { margin: 0 0 8px; color: #2c3e50; border-bottom: 2px solid #3498db; padding-bottom: 5px; font-size: 15px;}
        .info-total { text-align: center; margin-bottom: 10px; padding-bottom: 5px; border-bottom: 1px dashed #ccc; font-weight: bold; color: #333;}
        .info-row { display: flex; align-items: flex-end; margin-bottom: 4px; }
        .label { white-space: nowrap; color: #555; }
        .dots { flex-grow: 1; border-bottom: 1px dotted #aaa; margin: 0 5px 4px 5px; opacity: 0.5;}
        .value { white-space: nowrap; text-align: right; }
        .pct { font-size: 0.9em; color: #7f8c8d; font-weight: normal; margin-left: 3px; }
        
        /* MARKET FILTERS (Inside Info Panel) */
        .market-filters { display: flex; flex-direction: column; gap: 5px; margin-bottom: 10px; padding-bottom:10px; border-bottom:1px solid #eee;}
        .filter-row { display: flex; gap: 3px; justify-content: space-between; }
        .filter-btn {
            flex: 1; border: 1px solid #ddd; background: #f9f9f9; 
            padding: 4px; font-size: 10px; cursor: pointer; text-align: center; border-radius: 4px;
        }
        .filter-btn.active { background: #9b59b6; color: white; border-color: #8e44ad; font-weight: bold; }

        /* LEGEND */
        #energy-legend {
            position: absolute; z-index: 999;
            background: white; padding: 8px; border-radius: 8px;
            box-shadow: 0 0 10px rgba(0,0,0,0.2);
            display: none; flex-direction: column; gap: 4px; font-size: 11px;
        }
        .legend-item { display: flex; align-items: center; gap: 6px; }
        .color-box { width: 15px; height: 15px; border-radius: 3px; border: 1px solid #ccc;}
        
        @media (min-width: 601px) { #energy-legend { bottom: 80px; right: 10px; width: 120px; } }
        @media (max-width: 600px) { #energy-legend { top: 130px; right: 10px; width: auto; } }
        
        /* BUTTONS */
        .btn-wrapper { 
            position: absolute; z-index: 1000; display: flex; 
            flex-direction: column; gap: 10px; align-items: flex-end; right: 10px; 
        }
        @media (min-width: 601px) { .btn-wrapper { bottom: 30px; top: auto; } }
        @media (max-width: 600px) { .btn-wrapper { bottom: auto; top: 10px; } }

        .map-btn { padding: 10px 15px; background: #2c3e50; color: white; cursor: pointer; border-radius: 50px; font-weight: bold; border: 2px solid white; box-shadow: 0 2px 5px rgba(0,0,0,0.3); text-align: center; font-size: 14px;}
        .back-btn { display: none; background: #e74c3c; } 
        .locate-btn { background: #3498db; }
        .legend-toggle { background: #fff; color: #333; font-size: 12px; padding: 6px 10px; display: none;} 

        /* HOUSE NUMBERS */
        .house-num-tooltip {
            background: transparent; border: none; box-shadow: none;
            font-size: 12px; font-weight: normal; color: #444444;
            text-shadow: -1px -1px 0 #fff, 1px -1px 0 #fff, -1px 1px 0 #fff, 1px 1px 0 #fff; 
        }
    </style>
</head>
<body>

<div id="map"></div>
<div id="loader">Processing Area...</div>

<div id="layer-control">
    <button class="layer-btn active" onclick="setMode('stock', this)">Stock</button>
    <button class="layer-btn" onclick="setMode('energy', this)">Energy</button>
    <button class="layer-btn" onclick="setMode('transactions', this)">Market</button>
</div>

<div id="info-panel">
    <h4>Riga Data</h4>
    <div style="text-align:center; color:#777;">Click a neighborhood</div>
</div>

<div id="energy-legend">
    </div>

<div class="btn-wrapper">
    <div id="legendToggle" class="map-btn legend-toggle" onclick="toggleLegend()">üìù Legend</div>
    <div class="map-btn locate-btn" onclick="locateUser()">üìç Find Me</div>
    <div id="backButton" class="map-btn back-btn" onclick="resetMap()">‚¨Ö Back</div>
</div>

<script src="neighborhood_data.js"></script>

<script>
    var map = L.map('map').setView([56.9496, 24.1052], 11);
    map.createPane('labels'); map.getPane('labels').style.zIndex = 650; map.getPane('labels').style.pointerEvents = 'none';

    L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
        attribution: '&copy; CARTO', subdomains: 'abcd', maxZoom: 19
    }).addTo(map);

    // --- VARIABLES ---
    var neighborhoodLayer;
    var buildingsLayer = null;
    var houseNumbersLayer = null; 
    var userMarker = null;
    var currentActiveBuilding = null;
    var currentSafeId = null;
    var currentMode = 'stock'; 
    
    // MARKET FILTER STATE
    var marketUnit = 'sqm';   // 'eur' or 'sqm'
    var marketStat = 'median'; // 'min', 'mean', 'median', 'max'
    var marketTime = '5y';     // '1y', '3y', '5y', '10y'

    // --- COLOR LOGIC ---
    function getStockColor(d) {
        return d > 10000 ? '#800026' : d > 5000  ? '#BD0026' : d > 2000  ? '#E31A1C' :
               d > 1000  ? '#FC4E2A' : d > 500   ? '#FD8D3C' : d > 100   ? '#FEB24C' :
               d > 0     ? '#FED976' : '#FFEDA0';
    }
    function getEnergyColor(cls) {
        if (!cls) return '#95a5a6';
        switch(cls.toUpperCase()) {
            case 'A': return '#2ecc71'; case 'B': return '#a3e059';
            case 'C': return '#f1c40f'; case 'D': return '#f39c12';
            case 'E': return '#e67e22'; case 'F': return '#e74c3c';
            default: return '#95a5a6';
        }
    }
    function getMarketColor(val) {
        // Purple Gradient for Price/Sqm (Approx range 500 - 3000)
        if (!val) return '#bdc3c7'; // Grey
        return val > 3000 ? '#4a235a' : val > 2500 ? '#5b2c6f' :
               val > 2000 ? '#6c3483' : val > 1500 ? '#8e44ad' :
               val > 1000 ? '#a569bd' : '#d2b4de';
    }

    // --- MODE SWITCHING ---
    function setMode(mode, btnElement) {
        currentMode = mode;
        document.querySelectorAll('.layer-btn').forEach(b => b.classList.remove('active'));
        if(btnElement) btnElement.classList.add('active');

        if (buildingsLayer) buildingsLayer.setStyle(buildingStyle);
        
        // Legend Logic
        var legBtn = document.getElementById('legendToggle');
        var legBox = document.getElementById('energy-legend');
        
        if (mode === 'energy') {
            legBtn.style.display = 'block'; legBox.innerHTML = getEnergyLegendHTML();
        } else if (mode === 'transactions') {
            legBtn.style.display = 'block'; legBox.innerHTML = getMarketLegendHTML();
        } else {
            legBtn.style.display = 'none'; legBox.style.display = 'none';
        }

        refreshInfo();
    }

    // --- MARKET FILTER LOGIC ---
    function setMarketFilter(type, val) {
        if (type === 'unit') marketUnit = val;
        if (type === 'stat') marketStat = val;
        if (type === 'time') marketTime = val;
        refreshInfo();
    }

    function refreshInfo() {
        if (currentActiveBuilding) {
            updateInfo(currentActiveBuilding.feature.properties, "building");
        } else if (currentSafeId) {
             neighborhoodLayer.eachLayer(function(layer){
                 if(layer.feature.properties.safe_id === currentSafeId) updateInfo(layer.feature.properties, "neighborhood");
             });
        }
    }

    function toggleLegend() {
        var leg = document.getElementById('energy-legend');
        leg.style.display = (leg.style.display === 'none') ? 'flex' : 'none';
    }
    
    function getEnergyLegendHTML() {
        return `<b>Efficiency Class</b>
        <div class="legend-item"><span class="color-box" style="background:#2ecc71"></span> A</div>
        <div class="legend-item"><span class="color-box" style="background:#a3e059"></span> B</div>
        <div class="legend-item"><span class="color-box" style="background:#f1c40f"></span> C</div>
        <div class="legend-item"><span class="color-box" style="background:#f39c12"></span> D</div>
        <div class="legend-item"><span class="color-box" style="background:#e67e22"></span> E</div>
        <div class="legend-item"><span class="color-box" style="background:#e74c3c"></span> F</div>`;
    }
    
    function getMarketLegendHTML() {
        return `<b>Price EUR/m¬≤</b>
        <div class="legend-item"><span class="color-box" style="background:#4a235a"></span> > 3000</div>
        <div class="legend-item"><span class="color-box" style="background:#6c3483"></span> 2000 - 3000</div>
        <div class="legend-item"><span class="color-box" style="background:#8e44ad"></span> 1500 - 2000</div>
        <div class="legend-item"><span class="color-box" style="background:#a569bd"></span> 1000 - 1500</div>
        <div class="legend-item"><span class="color-box" style="background:#d2b4de"></span> < 1000</div>`;
    }

    // --- GEO & DATA LOADING (Standard) ---
    function locateUser() { map.locate({setView: true, maxZoom: 16}); }
    map.on('locationfound', function(e) { 
        if(userMarker) map.removeLayer(userMarker);
        userMarker = L.marker(e.latlng).addTo(map).bindPopup("You are here").openPopup();
    });

    function loadNeighborhoodData(safeName) {
        currentSafeId = safeName;
        document.getElementById('loader').style.display = 'block';
        var buildVar = "buildings_" + safeName;
        
        function checkDone() {
             if (window[buildVar]) {
                 document.getElementById('loader').style.display = 'none';
                 refreshInfo();
             }
        }
        if (window[buildVar]) { drawBuildings(window[buildVar]); checkDone(); } 
        else { loadScript('building_chunks/buildings_' + safeName + '.js', function() { if (window[buildVar]) drawBuildings(window[buildVar]); checkDone(); }); }

        var numVar = "housenumbers_" + safeName;
        if (!window[numVar]) loadScript('housenumbers_chunks/housenumbers_' + safeName + '.js', function() { checkZoomAndDisplay(); });
        else checkZoomAndDisplay();
    }

    function loadScript(url, callback) {
        var script = document.createElement('script'); script.src = url; script.onload = callback;
        script.onerror = function() { document.getElementById('loader').style.display = 'none'; };
        document.head.appendChild(script);
    }
    
    // --- DRAWING LOGIC ---
    function drawHouseNumbers() {
        if (!currentSafeId || !window["housenumbers_" + currentSafeId]) return;
        if (houseNumbersLayer) map.removeLayer(houseNumbersLayer);
        houseNumbersLayer = L.geoJson(window["housenumbers_" + currentSafeId], {
            pointToLayer: function (feature, latlng) {
                var num = feature.properties.numurs || feature.properties.housenumber; if (!num) return null;
                return L.circleMarker(latlng, { radius: 0, opacity:0, fillOpacity:0, pane:'labels' })
                    .bindTooltip(num, { permanent:true, direction:'center', className:'house-num-tooltip', offset:[0,0] });
            }
        });
        map.addLayer(houseNumbersLayer);
    }
    
    function checkZoomAndDisplay() {
        if (map.getZoom() >= 14 && currentSafeId) drawHouseNumbers();
        else if (houseNumbersLayer) { map.removeLayer(houseNumbersLayer); houseNumbersLayer = null; }
    }
    map.on('zoomend', checkZoomAndDisplay);

    function style(feature) {
        return { fillColor: getStockColor(feature.properties.Total_Units), weight: 2, opacity: 1, color: 'white', dashArray: '3', fillOpacity: 0.7 };
    }

    function buildingStyle(feature) {
        var props = feature.properties;
        var color = '#2c3e50'; 
        if (currentMode === 'energy') color = getEnergyColor(props.Energy_Class);
        else if (currentMode === 'transactions') {
             // For map coloring, use 5y Median EUR/m2 as the default "Heatmap" value
             var val = props['5y_sqm_median'];
             color = getMarketColor(val);
        }
        return { fillColor: color, weight: 1, opacity: 1, color: '#555', fillOpacity: 0.9 };
    }

    function onNeighborhoodClick(e) {
        var layer = e.target; var props = layer.feature.properties;
        if (!props.safe_id) return;
        map.fitBounds(layer.getBounds());
        if(neighborhoodLayer) map.removeLayer(neighborhoodLayer);
        document.getElementById('backButton').style.display = 'block';
        loadNeighborhoodData(props.safe_id);
    }

    function drawBuildings(geojsonData) {
        if (buildingsLayer) map.removeLayer(buildingsLayer);
        currentActiveBuilding = null; 
        buildingsLayer = L.geoJson(geojsonData, { style: buildingStyle, onEachFeature: function(feature, layer) {
            layer.on({ click: function(e) {
                var clicked = e.target;
                if (currentActiveBuilding && currentActiveBuilding !== clicked) buildingsLayer.resetStyle(currentActiveBuilding);
                clicked.setStyle({ color: '#ff0000', weight: 3, fillColor: buildingStyle(feature).fillColor, fillOpacity: 1 });
                clicked.bringToFront();
                currentActiveBuilding = clicked;
                updateInfo(clicked.feature.properties, "building");
            }});
        }}).addTo(map);
        if (houseNumbersLayer && map.hasLayer(houseNumbersLayer)) houseNumbersLayer.bringToFront();
    }

    function resetMap() {
        map.setView([56.9496, 24.1052], 11);
        if (buildingsLayer) map.removeLayer(buildingsLayer);
        if (houseNumbersLayer) map.removeLayer(houseNumbersLayer);
        if (neighborhoodLayer) map.addLayer(neighborhoodLayer);
        document.getElementById('backButton').style.display = 'none';
        document.getElementById('legendToggle').style.display = 'none';
        document.getElementById('energy-legend').style.display = 'none';
        updateInfo(); currentSafeId = null; currentActiveBuilding = null; houseNumbersLayer = null;
    }

    // --- INFO PANEL LOGIC (UPDATED) ---
    function updateInfo(props, type) {
        var div = document.getElementById('info-panel');
        if (window.innerWidth <= 600) div.style.display = props ? 'block' : 'none'; 
        else div.style.display = 'block';

        if (!props) { div.innerHTML = '<h4>Riga Data</h4><div style="text-align:center; color:#777;">Click a neighborhood</div>'; return; }

        var title = (type === "neighborhood") ? props.apkaime : (props.Full_Address || props.Building_Cadastre_Nr);
        var html = '<h4>' + title + '</h4>';

        // --- TRANSACTIONS VIEW ---
        if (currentMode === 'transactions') {
            // Render Filters
            html += `<div class="market-filters">
                <div class="filter-row">
                    <div class="filter-btn ${marketUnit=='eur'?'active':''}" onclick="setMarketFilter('unit','eur')">EUR</div>
                    <div class="filter-btn ${marketUnit=='sqm'?'active':''}" onclick="setMarketFilter('unit','sqm')">EUR/m¬≤</div>
                </div>
                <div class="filter-row" style="margin-top:3px;">
                    <div class="filter-btn ${marketStat=='min'?'active':''}" onclick="setMarketFilter('stat','min')">Min</div>
                    <div class="filter-btn ${marketStat=='mean'?'active':''}" onclick="setMarketFilter('stat','mean')">Avg</div>
                    <div class="filter-btn ${marketStat=='median'?'active':''}" onclick="setMarketFilter('stat','median')">Med</div>
                    <div class="filter-btn ${marketStat=='max'?'active':''}" onclick="setMarketFilter('stat','max')">Max</div>
                </div>
                <div class="filter-row" style="margin-top:3px;">
                    <div class="filter-btn ${marketTime=='1y'?'active':''}" onclick="setMarketFilter('time','1y')">1y</div>
                    <div class="filter-btn ${marketTime=='3y'?'active':''}" onclick="setMarketFilter('time','3y')">3y</div>
                    <div class="filter-btn ${marketTime=='5y'?'active':''}" onclick="setMarketFilter('time','5y')">5y</div>
                    <div class="filter-btn ${marketTime=='10y'?'active':''}" onclick="setMarketFilter('time','10y')">10y</div>
                </div>
            </div>`;
            
            // DYNAMIC DATA FETCHING
            // Key format: "5y_eur_median"
            var key = marketTime + '_' + marketUnit + '_' + marketStat;
            var val = props[key];
            
            // Format Value
            var displayVal = "-";
            if (val !== undefined && val !== null) {
                displayVal = Math.round(val).toLocaleString() + (marketUnit === 'eur' ? ' ‚Ç¨' : ' ‚Ç¨/m¬≤');
            }

            // Turnover Ratio Calculation
            var salesCount = props[marketTime + '_count'] || 0;
            var totalStock = props.Total_Units || 1; // Avoid divide by zero
            var turnover = ((salesCount / totalStock) * 100).toFixed(1) + '%';
            if (totalStock <= 1) turnover = "-";

            html += '<div class="info-row"><span class="label">Value</span><span class="dots"></span><span class="value" style="font-size:1.2em; color:#8e44ad;"><b>' + displayVal + '</b></span></div>';
            
            html += '<hr style="border:0; border-top:1px dashed #ccc; margin:8px 0;">';
            
            html += '<div class="info-row"><span class="label">Total Stock</span><span class="dots"></span><span class="value">' + (props.Total_Units || '-') + '</span></div>';
            html += '<div class="info-row"><span class="label">Total Sales</span><span class="dots"></span><span class="value"><b>' + salesCount + '</b></span></div>';
            html += '<div class="info-row"><span class="label">Turnover</span><span class="dots"></span><span class="value">' + turnover + '</span></div>';
            
        } 
        // --- STOCK & ENERGY VIEWS (Same as before) ---
        else if (currentMode === 'energy') {
            if (props.Energy_Class) {
                 html += '<div class="info-total">Class: <span style="color:'+getEnergyColor(props.Energy_Class)+'"><b>' + props.Energy_Class + '</b></span></div>';
                 html += '<div class="info-row"><span class="label">Efficiency</span><span class="dots"></span><span class="value">' + (props.Energy_Eff_Heating || '-') + '</span></div>';
                 html += '<div class="info-row"><span class="label">Consumption</span><span class="dots"></span><span class="value">' + (props.Energy_Total_Consumption || '-') + '</span></div>';
                 if(props.Renovation_Info && props.Renovation_Info !== 'No') html += '<div style="margin-top:5px; color:#27ae60; font-size:11px;">Renovated: ' + props.Renovation_Info + '</div>';
            } else {
                 html += '<div style="padding:10px; color:#999; text-align:center;">No Energy Data</div>';
            }
        } 
        else { // Stock Mode
            var total = props.Total_Units ? Math.round(props.Total_Units) : 0;
            html += '<div class="info-total">Total Units: ' + total + '</div>';
            if (type === "neighborhood") html += '<div style="font-size:11px; color:#777;">Zoom in for details</div>';
            else {
                function row(l, v) { 
                    var pct = (total > 0 && v) ? Math.round((v / total) * 100) : 0;
                    return '<div class="info-row"><span class="label">' + l + '</span><span class="dots"></span><span class="value"><b>' + (v||0) + '</b> <span class="pct">(' + pct + '%)</span></span></div>';
                }
                html += row('0 - 25 m¬≤', props['[0-25]']);
                html += row('25 - 50 m¬≤', props['[25-50]']);
                html += row('50 - 75 m¬≤', props['[50-75]']);
                html += row('75 - 100 m¬≤', props['[75-100]']);
                html += row('100+ m¬≤', (props['[100-125]']||0) + (props['[125-150]']||0) + (props['[150-175]']||0) + (props['[175-200]']||0) + (props['[200+]']||0));
            }
        }

        div.innerHTML = html;
    }

    neighborhoodLayer = L.geoJson(rigaData, { style: style, onEachFeature: function(feature, layer) {
        layer.on({ mouseover: function(e){ e.target.setStyle({ weight:4, color:'#666', dashArray:'', fillOpacity:0.7 }); updateInfo(e.target.feature.properties, "neighborhood"); }, 
                   mouseout: function(e){ neighborhoodLayer.resetStyle(e.target); if(document.getElementById('backButton').style.display==='none') updateInfo(); }, 
                   click: onNeighborhoodClick });
    }}).addTo(map);
    
    updateInfo();

</script>
</body>
</html>